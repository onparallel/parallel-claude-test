import { Knex } from "knex";
import { isDefined } from "remeda";

const validEnvironments = ["local", "staging", "production"];

const encryptedCredentialsMap: { [key: string]: Record<string, string> } = {
  staging: {
    54: "0cd7c3a87bf50788346ce72e742a1f87bb02a95481222e929f3c6243736aaee8f6aef7f0f19796fbcdeee07a04e50c7bf0bd31e06c08de9344cd802f6f0ddf9066a4a291d4e36c933f08389255f2d40d6faf9f6a805e7f2b2ac3aa5d41f741d01c9d6d1de56c223dc5085853ebf4522d878b53e601eecc2c2686603f46fdbe79972dfc255fc599cfd3706fe46c8ef087577fac4be90ca2fe320f5e577c548ee2c588043d0dea30838ddb409e3e51e50b06e8ebf101aa3ff3b9ecc34b400195291240fb029b2b07b4108892d2dbdbf8763533783adbca21593a97b1d1bd0e64e9cca34e8cc6c4109b5d96d745d3d1fe44b222ee4f43f06797ed609f82abc02fdcb8694fc3f00dbad063b8284238292229d5f913131e4fc7e5cc95ad3c2c9454594e6274ef95d8f7650d66c727c9606839b29a9c3e88e80655ab9a692b3a3d362276d5659116e6170680ff38c4e198176dc3af8bf67a94487088c3dba95f2ca9017894d77759901e3bde60dace741b2edd6812cba527ea453828333ada8b77949d68bda196e81591cd5a962d9c5c6a4cea0ae1b744a6806405ce72e5af6d4674fb7b160de39dad2efc8cad2aed15278afb61dc394dada64eeba8a0aa542b6df906f7316823227d0e254365e1a8eae3486bd2484ed2838fd62bcc8536f86ca688175dfdff5a49fb1a5ebff45976feebb22b2b2baa04ace78e0a185424ef31b91857ef33d1ba971104e62ba70b280b87566094461f46e28735f446b3f5b8db22a874c38f4085922696984b2ed4d8f624365267d8edc7cadddd3d1d91e2bf4d6f522191c3b75da1699b08ec2655307b5bf45757acb90b0bc93850dd2dd856a0fd25f5cf59afe6c4b8a10e31c601a23ac6951fde34a638075007f92e20bbbbf1b4e39834e264aba0062ca99adb2e6385d482fbeccad847c84362951f0cb963f4bf655a5366a62671f1e6b86100437716886bc0b6a4b581acdc274e5968c5593a37e999f04667310c07e91a5cf4b0ef83b522aa9f7d54acca53fc9e136f343379894f298c10a5d2a9d14ab8d7a0da3385a95bceb08ef6684faae445a802f6c46b0b1d1ed6c0abac88ea2d74ccd8fb3b57716074be2584e4f15821406840b705ed963cd4ea0087ac7d6e30c6e883254307745441dec3c48741fa6c9a99a43cb1eea83143bf4e884822a292ccb6b61880d72ddf1eb691e5960ac6b9981e4644e9faa4c3408d8e3dc46a2b2e76867e21761eacdf2dc1ff8f430279d5f2fcf51e9ce9bc0e3108fed5da77160b6cc0929ca9fc441a49d170e141ff9dca58cb9675e11091be36e322f55dda03f9a9be2eeb08a184838bf2f88e8f49cba5a2646dea6cc5c7fc83f43bd97f60c8f0f2e2c3df57839d94157e9769f3e41e85382adfa3e233d3bb437f1ba2ae69a2d1705386e708eb4ca082179b481a5a12d67eb4a98fb07472760f2add0d915eca8cd2847c09bacac9899e893db09fa962efc8ad41d1508de405da898ffa4aa1c5cff1822300a1d4ced51efefbab90707dc876e4c32a368da2c2fd5e422152de31268c113ce9a4554ce039ffd50047e5becb61ec907b3c3817cddd8db64155171e11bac4f209d0b3fbe0d6be6371072278b5badbe0eb2be7f72841c1b5c9c741b62944d82de9d3aea2f4234aa0b093fd768e6c80d6c9aa71d80c0e55c242f394af96d20221a5568f60090fbdc5cd9010c7283bdf5bb876304535450f7b25529959c95b9b73dfb7cd8315da6bf25e7b3b8b97e27307a6aea7ef1b3d849baf115383c5e6c6ee32843458b0087025b2d3c8d0c8e4187aa7641ab963ad71cc41c3f9f302337c4c0939f54f9047c03728e1384abeb1904a832754bfcb59121dc4bfda52e66a70f0aa27629afa0fe261a20836c93b62844966853d5893629cae22fd87581bb69c0f56b20b6be6d457fbbe514cd872ba319f3d5aeae51838afec8cbf07040de3d6d882775a37b961f06b9daf1db01d8d29e907493ee4bf37687a396e3d5031a7842f58e48c65d7246ebfe36317fd418b354dc67c0762f5b5faa179c686642f565510e977f369103185711bb53cda841d1cb0ce774545483556ba7d70ae021ffb344eeb53e030865ab7089a2d6c",
    55: "0c41ceec58b4fa3170183b66f81dae9867c2845d765c84637eda52c799b15c973dd1da74f1a5fec6b888b7902171c43cf17aefe775973b8b54ac32d9d8e00e6c64694daf82420fdaa50cddfea978144b043e3845a8f2dcc0e0dea0bc25e1f90ec3f4ae2968ee26c8f51bc9a013d680b471b1d87e2c99a81c68a9746ddcf542627431c39863a920da283c5aa6e2b005c9014eb3a8fe1591a7ba55be6db78483a7c3ef6d185be6f144a30355658900add360f160c21e2f5785850be1746c2ce03cffdb7010289918e5ba9fb8c6c095fe4eaaadce37320a57c91c42102934c8883fd0ab4cc8db68a978b2363592f8e34c14de5afc34632d30ff42f58febed75f70919b51c18326cd1532ce7ae3ac25f3fda5d6b566f55c6d048a30a85faea477eee4662a12de9cb86cceb0b0e61f5a31b98ac13093259db240f230ab80e4e69ef416fc367f50f89b20455fd58b024c1d09c3585a6c8a276f03f6d307c562b346bb8ccb12e15eee736ffc3cac20d2d5f8742bbf1e84690730f3b76995e5a4dd36ce6444b92032b8e85ecdfafb51a95f76952fc7154b7b6f1c885ddb6f29bc9382404fe898ec4b321a136ae4669370e09355dee21b06393e62a60695ee1ab2ede649c82d563079bd48721dc3d5b161ed8f28999e4b7d676ba445dcda9b22c15031498167e350669923786dcecf2cafb7c7fe4de3fe870afbd742cb30dead40dc0f8da334d782df7f3f9ecba3cc8c2e3c8820ce09852969b326377b68bed67d7f1f600dcb993d48f686c63dedf24aec98472bdea2857e9f48cbc3bd2e0e28536a04eb896147bf0d2e0019cf1ed39e8530724c3dfdbeea1ad8f47cf60bb442f7e617b64fa53dbb12aacd5c28517600c86439f3a06c86a0516121929a0097984cc5a628679e180e83523f9c246f1f5cf2450dcd747552cdea3637d47440e3e5021bd7ac80a91755dec5392202184d369f0fe8097c4187c5912523721476ebe29a69c2e46d21edf2854681844425c1766adb798c443fac0621b9e64e5eef7ae3e76e75a3e58d0ced0bad3ca21b0ff8df1cc285bd89ed4a1380b1348bc0f24fa285f86c23e147a055281d9c0fe28dfd8831c069ad783dfaad36957831733515fc1016d5ec989afc30b43f2328dd1c7faf1429c0a2366fdad509e17fdcc40101aaf626bf98ba41017dd72f2ead8773fabfab4c3e615e30aac1267eb694019a6885f6658cff949486d2d3cdeda4fc587d4f179f069efeaf607f4e15745d31a314f7043a38d4ea7fb347a2c14854a42c21eb36e785323ee2c2444b79c1c6aa3e20c3a8df70642bafd16c567e7cc7bcbae14c0d0890e32fd42afdf9c8fdb204da222f853007d05e2a999b4de930fe5304a23adb23c74451827a8454c97aa3d54d46b66082fbab67365f4d3d77568602ccd8cc4acc2dca1a8babd74900d489fb5b74cbf65f8cc89e24d61420523ecbaabf5e17baa3c052b8b8bd52862c6399f48478f72a7779ac3487f51e14e7a21f0e46399db8ae89e2ad0cc51483b08d906111bb8b7497e664c18a1c446c5a5eb72d7af204b71bddadc9ed563674f037da4e3881a54f67e53f41b45cb1a0afaaa4e46e802f3afd597b061d50265a435111492fb6c49b4dd9c7545745ea4412072c86c74c03721eaa534ebde1c497d15f9213a9492da48b76aa0da3cc4d5c570b96f95cf372f36bab675f9537d8e7e1e9e97d9f5c9d784fa403b72cc43eb577a06abf4cf819e48fbcb872e151f8a53a67494273e7d74e44626d9c2dbf2d9839701653b3db6b5b4a89bd0b897540af3927914a6f36a49a78c76967d62835b831be0dc5974063ddf2a86557f0a5f9f8ae6fdbb19494d9342c075480ceda7006b1f9bafb5dc66621cabb2657cbb04f23360d81a476611f01407cfa54e1189579df05beedf655884d73cf08dc3318afa5489a13c2842bd9abde7d00033dca6d92943a2abc5355f95dd5bd94145a80780376c5d581e4eba785801ae2d25f8f6844aae1f839a4a5cad47b95858c60aaf2120887c41532c125e7901cedab1453d7aabd5b959b7cdd1bd106b3c93f81af507d92c6688382d7ff5236fde3f6f315f41527d435f75a0fad9ce32c78eda7b7e9b95",
    56: "0c763788e9d7b9b7238ee48a12f81086b8160d0a9a13f612e3ba77fe69267a736a7592cc9e708f802b216a3a578e7411c6448a6a97a2c7a75e2c5ce083e4f50de2208851e2c0be3051cc45f72953a60013c4629b3d460b658eabcf927cffb79dc5b69548b62e3247b3910f38ae386351b4b3e91a80bc58325dc92dfc6b7ffa3a6d7777c4c5a460e21a82ae3b3daeb41317da8a506a1b3284703e4304c23adede937d23b37c1ae037097e9b11ac9e4d5f6e6c27bf7b7d7f8c24eecb007df8960c9803f462eb17533ab09bab7b3fabcda53294dce4f1acfa66652f21cc2869bc98e46ac8160775f060ee76ab6b9874761b65cd2050cfdc4f1899f16a988642d08d507481e7f7cefabb84cdf16f2fb7ac271985fc8b184a3d8660f911cb33eb4fa014466549370ce6dd733772ec4d63cc7d468341dc5af781988420fc710539318d49272a74307e0abfff4269525e1e34985c9315c078fcc6c4f3bdf138c4e673e8fddf33497102a5dcc5e36ce1af0754c6af885b2636e5ab3a1fb20da7a56b238b4425ea86b18f8456c687bc545ace4d3876a7128aa4399801fdfd2c9b3376ea26a6f7c8539c21d3d8a96afa26de1bf5d71368784e6b8d90a115c991c05b0154d90ad00e15f651d1275f12aa3cd40289d398d2151d9b3bbc1a0271306182c52467ad0f708e4874cce1d5818cf7e1f0e0f527d2093995599927cef57af8bd09c709fde35a4fcf0fd998e1c552251e0db8bc27074998e4aebc387569ab365ca6270c563e3c247337e2f54b10ff98144c7ee575ea27ef88a8c1e53058557cb37c41106b3901c9e8d8cee3ae524d39464bc2bad1ad1a97f020f4372defee907c7c5c3f55c12c5612b8c0c448a6df36ace868ee8c6c79e4149174821e120f68e83d883476acb73feafb00e0558e7f48daa33801175bf8eb04d21c0f1c0fdba20b10560ae78e109f9140aea697aa2623218080d61ceb890ab71c8e9cba0c4756150f7c44c3e2f8847103c37d27a7b4fe636cb2a8c14c929a80a7383c87140d35d275e8bdb1f060a6f3b58174b1aa8ec596e0b0fbe24fad4b87573cdc080c4c580eddf500c635340486833c7c7e2cc10e83d9e8f05bf1e11de154ca9e9ff8c245c37573f685af1ffc34b5f41f47531fd1ef56de2eb4d8a3ba5ceefd893a5c64b9d51b248cb1497a4554b7320874968dd91d85296c0defbc213730ab447d7966e5644f28fd670494604ef49000ff31494e813e0e99316fd91566edc3f3d3be8b8b713fef18aee4374e38922305f2ec44cd06f213a7b7240b3587e99081ce0ed23cdfd4a828eeb69f7f970487f398d52542051be52a59ddbc14c2fe95b2357a7ddbb2e1d11d1aaf4ad26ed26ecdcdedca999cec20c4a0ebc8738457eccf89f8b4b22c6574372e0fb6a319d3f216f2c5b782d491e62249ae94e7361b4a09867775e9241e07a8aaccd21ce6499a0d06f0459318f67cde95567e54a9256b6f36a45e22a15e49a0e653f8da1300f81fb130ebb1a5bf31a158de2c97f4bd7dfb186bde360e7d3c6ffcd03e11a7760bced73566273c7db101a1d6a6f1bcbd2a36facb24d0f91370f94363bba433205b5ff0b162327b5c7fabf77c06ab2b8112880bc507369bde7217b0610fc47db4589631c6bd0c2d481610f2be3cf8707713bedaccc6a0524ea454ad110bb07963353e619e772346e3ffb14bb1ac1e5c6463efbecd4ad3150c9660584b6f74530353d6de0c73fac0984e6d849e4faf8f151bc826c42179e51114de15f43f64d2636bc19c72b25e04b99730c7dcc25b4622bf1cd5d12511e4ec461ff77869ce094ac4af060b95f6b505bd1bf8c4a96389590223f1c181c5aee9165d04842e142593aedf1a6defb6a848bc553a575ca70801dc",
    57: "0c559bc983350bc4ba5cb9cdc5d39cbc0d032da24fd2475b0fea9b6932f5525b44583fceceafdf17b09caeffa21353d98b99c4bac93d6aeaa2cbc9a0465381099bd5c90ca5ac548e3eb82dc7c2b979e145464d732d4d45042f595bf1c4499d61169ca5c90b075d608f27f35734082bb81a726f98856df3db6f62fd63f72f2482acc981b4ee51bd2c91ea658a26e5665a20b1f628d94b244f880506dc038140b45dad0d3303ea32cbcb27bd4b44436487ea97d3cde6bd77a53b0e7bb982f338d5aadbe23c7799a32898ea1a29c0df182d4a90f4de75cafe8696b080ccc1be7d8d8555f0d81db2f03f1218932317b3f026ad5228aa04fd55f58305a0df181823895da7bc21045100a358fd7fb42c6356f6c0e9153a51106c6e854ed0c35c752377cf1924ab49ed2a1852a27982fade8efb70f9f073105a21fd2497687fb5dc64ac8cccfc7756dbaeaa66a55facc40b70a769334109f7621723522c86fb3031fc4503d31e9d7a8a633362c36f58f1b7aefb85bf5edc0e8db93f33e9693ccc1105927aeced01028919c2ffe5c958da6dd51f0c1d36d1e921c702e31d0bf34f3885a0ac084d46872c505f40776ee25e4bdc69cb65c2b3363efa227cf6cc1709cd76a33b9912c83b8dcd1a4ea16849288ee994705f2155dcd85278d81b520d7a5cd304dc228e0e42a89b609fa9c453526f263207126e6056e9a82a4d96b0a91f6f5b1e727f658f450ab554794bf3bb900cc776a554e19a0648b0061a3aa8a259b807a08d50adc4ef55e530c09a50d6b0eebf959b3cc5d5acf2a80fe1fe4260c41779d7ccade2fbc37511fef75ba734b3096620291d0daff377b18b329629b62469c8a673a4e0b1c4d2a6d2829a1f4a0ea3a5549f3d21e74f9d4555d06ebd11fd91d9cfabe3fcbf43a3a8482a07e40a259c5f9cc3c79fe1b274736693f239d63664f8f6e54d36e8030dd2532e7d5e3dd368c7490f531cfb39aea3ead0ea19fd1202021ef07ace7c44da17ee258bba1b3ecdf9ab92039659d6be9e31830452a5be700aca75928df9a6fd9d10439de45ead0efcb0eaa2c26e015a9aa04161a560370c1feb66216b15883fa005c6f176f7d8a10d131b1c25c287c9d04a0664c5faac694163b36caa1d4e9f347ec5b527f3e13f20e13a0144ae31761d30cf276b6146ea70a9dbf6e98831fbe8dd30c26eee99376eb9d227726e2de3a70b3ca2fab03bb963b0218c4c04d5f553d3392913b517e6e388720fd64e2bc6b9f7eb33c1c2bfacdd8d90a2baed3fee369992f8836e75f5bbf548a6791af5c80bb5b2a48f67dedfd6e2c928a46612bfc1ed0570908e44529caa74acb19884d677aa78e2778c9fbb1f2f54baab339570309aedc8c6224cc547c737547dce70c01f55aaa869b00be695cae20892d70ae6967b78290b9d74e1cb3f78e2a95e3e67e15c5bb30f358fe6e8e7e8524053b3c61e2c6f03f5277166a8a8adaf1a59ad4ae50935f2e4e566d4bc1904a21087950b4cea5b4505cce30d450dd4488a28278915e0754b5b65f3c649f4fc751e41722d2ac8c8fb3910e7d3485a8c29a139d70a37292e1709fa0854f40900857a87777dcc796aec75c93ffe41a2f6a991df72232bf3134379882e05413ef7a2369d53dc4a2063928e88d8573c7ed2c6b76c0e597e3d99a3310e0704de4477ae30babf83f52e85bcd0989dc21fb0a7c32369654a00427fe92665f2ae2a42d271f3bf92fffa7733db28f21710af5e7d028324bf62d84a9247bae3cc796f3e10c9044654ee7d3527dac59e1010037008f7987e0e105e5de05d47bf4ec5d5d161283a6d5684ac92ee34bae1e196d74937d4128cf10b216bca74b36d1547fa29e417d6fd4914c82243b4002fb3fd861970d8677a5c97cc",
  },
  production: {
    44447:
      "0c42ba49097dc68d396fbad88e538983b33a3641e910a8b991c8411f9aee0d4f6fba22039bcf5b5a4c7fd07141576b665f9e3d4ee76a65abf5c02b738dc07d755ca2b935e24f6eed72b10de7b58f305f2d24bc79c157ad4d7f4d9f758a3018b137cefea4b399edb8a3a0c8d342fc65a7895a2554622d646eb3305c0b400941618863e5e1a66445513f5a0e31ad019ccf36103219e29a2dc44253d818e6276ae2b4e3210f39274bf2bfc3cbf73a89b2d415d162cf2ab5325a2afdaebb7153dfea36ab90fe77af21e7c58b5aaaa53dbb3f4141e156562c9946eb431135f325c4eb336322d4c6a37fbc412e69bf8e99cd4d492c89fd7d81459a7eb3c5efdbccba596e4ea84903071e04712c52dbc7219dbddd055dd0f0679a60d31ac5be516faba01b1a66127aa75fa2a96604afb1ab24a2d5427d915bc61a873b6e5a578bc5a849752be5240472e6b75a9cfeab9cc0ce98db93fc92e0cbf0fe2fd9627258f5c1b3c1b295f3dd8d2fec4abc8d57b0bc51965975215fbcff68c889f176ca0b5a26d92116c8ae961b02910df5fab335f130de5883c4bf4549319da25cc1d1c58f4b41fb11215c44aed6b6d3d35b1f56d7fa266542abfd88238ab3537091e985765658d07b42fec68ba1514f692968823530aec2263e4b300af4e84c25b8a8d585a024827cacfab83c467c013ec7ceebbdf5cc5c1f8148c3ef64241b14becae278fb61a6329caa7cb9b14d99922ade0cc99c8dc5f814fb264b522aa00cf5edfd6557602455857c718076030162ded4e8ea43832c203c6c362f172b77e7b04359c633c58b6310218ec0199c3c2aa1b0f935ee3be5cf9173c5cc2209cfe8ebb8443f9f58f1538a3bc4d75d92b8996b9bb403f965f0492b5cfc8cdbba4a7f9ad1cf4d880d97adb72b3c998bbf2be7b824493637cadf1a488ea7c33c91e303db2f97c29237c9138cdab4876b871e5cd22ae7796e11f600ccfb552b501a8c94ce3e5e16065fcd9f4a65532fa9c80a5c84ca6b4091cc756b2c4684682f2194293a35cebbe2574069f6e699b314b4bf28c979562e33094c3126d7b00608bd6874ab540a77447f12fe43978ae6b8d7a747f082cc00e810016d485a10b0622d88786cf257238abecac945ad68e81d3bb747cb5b3e20b568f781e84bb9c2cb5fb27d467412cd05a44b6089c98bc7b2a14b86671caa64fd08ae83aaa9e1d66b4b2be17108f0938fe8b1b114976be9916be9e95adbc97395a92f2a5922ed2a2cf2b3441c66d965fa79b67a95d74a393edfdf03e022881f77dab7878a8d6cf6d3238395af50727fca810d597a1749f3a7df8fd22f8792d9da93a20ef04b9818c454ae01ad1934533d6dea9b4f3a3273683826308f73b2ac85249a4f0492f0ecf8aa352031469838244f96edda3d48725b7c571cacbd40b2f09df5e5d2307868683bf9e4e0e0a263fe001188653d1d0a8b2d62a5e33d948193e547196e1d7c779258bff3ce6e56cda1d8f544f3d0ff1e7d0e2905515969367196b9663c6350b58a764cdf79d3cf55c15bc5a88aa4126f9153e0e6ff0dabdef4605b6987dd2fc7bee2a34b84d15501faf58aa39e92b6b5f320fa9cdc3775ba642a0b9c6688f4a6c3dcf34066254518bd3f8d9fd614975eaf6ee91c1a82e5ed8108e19d384a97e1904ad759993143ec93b61c1209039e9306d9fd109222d501179664e57ced0bb672956d67f0e65c6629889bd5461ca1e0a17f2d145cb3da29d104d2c7a4bd44d61527c0ce25884419585337c3adc9404014cb5467fe3abb57182e18ac1133ef4b9b8eb149dd43bc300bef9afd1f71c4b7d3b9ea7fcd7bb587c0debee51f20b60f2c8ab571a9e2ddbdd9e67502015e559cd3b5cfd7e73345499543796102b76a2811",
    44448:
      "0cb722eedf3db47024323b24099ee16fc085834b2c8e94cc1f2698d9374658b309d2e924b765e8f3357fa6efa4a140890bdd8bd4cc7f68b54f4d835acedd6cc3751d780094afc36f65f5b1b46dab32494cd6eeb5f211aab8ec4e73db333a9ec041bcf22eb90a064fa18b823421d20260a10cc526cbe6e74dbc2e61cd093fb6cbef67c4a71892f6e2a9b6d7bfa91bb26b10eebea6db31967bbc3e7620bf7a02e7b1d20bdc06b8a2ec841c3070859f1bb6ed3203d8315f91b2d98c48e6d92050f3f9870452c96594e809a6b1192d21dbb7b6a9b00b3b25c6d471c0c6f7acce7e6c7c3c503a1d557aa0c59218efa911b39a33d825226a1f8e7ba8861ac01615a2854ed6cd0a157f409b36413aa967e592d5f4c3a8e31e6cdc0b8cdb09ba9059ae972ca572bf8359df7f873820370f2f51795ca471b2f1cdd78dff639c3a9dc0925fccc6eaae3fb7034a13289e88c7fae9602933f1b6f486c776b3a5c6c8846c2cad1311ea722e42d27b036d38d256c015b4530365f9cbb28f39dea2c29219e663c3c122c512c684c765d5a9e716518404b1b5b5bae293ea0f44ecd0608043b0dba07e809a46eef5bdff0d0ce88f1c3462101e8ca2aa997ac1f6bc795ccdaa3a184e08ead55cb392b63b993b7e58f8913be3be218490065dd36351c6def867b1a00ed8b085602b6a51a8fe094aca1d58f608c7d6fcc3fd294bca7af5af187b940a9c8c4a455f561b8148a350c80ddefe29d56554eacfe829ba144720abaf083d67ff1250a524b16d6c85b2fdbc28e343a1390255dd1299471049b52e2e576f88440099dba2fa7ff384ae092f8c80ad202e9af859cf0b4b361827f265944e89262cdeb30237e61d73c01f310a648d64283633ae1532a1eda237632ab63316b2d52de5377f3a5c00cc7bf71a1eef1eb0c19f95ec10285433dd3a2e1a87b1c66157dcbece18b6b2a7f7937a954df50f8d42877aa9374d0ce07d6889badf41d253c29a10153233d4267730e7a8b3929821985ec42a42530c2605c10b011ef136ec73430dbb4421c1acef760cee58823cee0f1f88e9fb66deb0e5ad022eddb6fb3f54f8895831556fd14f50338e2dcf244dc017b066a898191ddfbcb3a1e0cc11a31f9b66d0aafea2b135b69d6018292998c70dec0902c884fb1c00a3e51d32392e7804eaa6fac6639d249d3cab82c1f2c0f027bb264f0d4433997e48c3c779bb03bd66dad4c8da16dafcd56cbed8fc05c59b317b74e97b291245a23b007e2ddc77a674e4f00ec9dc5d75bdf45804e9cf2c1dc228459588d559510a4c1df5cb39faf39351733a92e68a4b83971e0828b746f7000461f7430d45672105a60ed7ca7c327f702560e4f60386e056098cecb884b6cba322d8599cab6665fab1d9c6bf7663ff533fb6a11f06043d13c0e207afb6fa74cccdf9d4ce97bbc4f1098bde56a0bbd089e6548df8a3864a785685eb7e2585eab530244aeaff5d10e6819ca29700a43defc7ef155f3e5237ee4f79081ea5ff80a0db821a188bbab5879dc52babb0fc61be57bbd13c4c1402af5ddee1321a0d0d771d2d9dc0fd9088977d085b7d48962081932b283660438c20b0c3a55601d2f2f358acd3bd932f78ed283e27139be0016428c1c63364cc0269b5847ead32f59687312dbaeab6913321d65213e1e752ef07ea2862b5be222f76d5b0e6d833a40ed19703210b1b90a6c470c36ce140d651c687741b25fc25515ea7665ee5e36b2eefdf15ba499daae3533427abad89d8021889f5ab238a4f49ac9f67665d17b1646d4a9525c6d0373a7bf28bd0d3f1c12f2da8d8512b88dee16661944f6b153967f41142d20ede98c1bb5819edfe365df11bde3a18c8ea925a5f54b7b09896edf1afb544e3eef3145b",
    44449:
      "0ca7592700e0ced01a2f9772aa9021534ae5c821aeb9fcc97c83a3e7b89b413fa8396f1d0fd8d773c9f869970160f994efb9d31764e4a8df6ede0affe290f41547807aa6a2eb4a4c22367a71adfee05d6cef4808ca3ea41364e19703a1f1450187f4b727b5d585029ad36417ca16d3b363063b71b6f86ff346c79ac471b78ff45b5d9a36a7bf389029394a4c69125d8fddf17fc5d1d1635a93ec415214a9d670d46758474e8d5a4152e38754f9669d91e0e8bb3d479ca28589f03e7aed8d76f5bb9bbca581ce8b5b7163b8767dd413ab81f6b7a323a088a2648c45d5b090d1438a5b02a21e609c49af1c1c5f5d16b67341809197aa22f66a4e2ae3a88bf290f1b1239fc586e1799b546a474184553daa8a62e0425e29188014131a240c9cd392ea556cbda43b81b0d658594c6e3be360b38e9e1dd2eef889a561321fafcda4aa2565474fedaa54013a9a944eccb97f391ab40312333ed3725b563974b311fa711d0d0503c38cc239b4929c5bdec204ed2d1cbbc826615ee05dbc82d26979d25bc472b88c4c9adc599f00b8d84b142df9fac43f7319b3e12a32e760e585479a4e4ed9c9b6c98bfc0cedf36308be09d53a8d424a81e1e73458a0e658fc7a1bd0ef4846e88d640ba7b25e0738ac0aaad1608f46a65e376f96814b7209dc4aa3b4f05085f1c304dc116b24075eda925aac1ac1b6addf672b03d8f9ac6328c462365b266e469edbc0abd7f4aa8148f5cd8589b786ae479accf8c9107e88e948b2411c9872caac47a767811d2e6d22babf45f5ee904386de17cfa6e450d6aabb270d48630411d547de623831c4277ec4adfee9d3f52eba009fa5610448442b8a8589109b32a5016bed7372e12ba6c7add2cdf13eb7addb84ed464e1256493508de5da519f155c71b96cfeeb68b83a394dea1be962ba7ecce40da182126ac193d15cc7e971d1d88e6e4f2eb83482c3ddeef975b05476444ea45158dae27a5828b2410b2ea3b4128e6d0e632f0c53d4e288fe6db7d1062c3db206cedd18c7829124d20f63b8a8325595510aefec01cbafaa4c19a829675d18789fb8e8041ee48b57753c4288963785e8ea916a0afc09edc4c7493fbc98369143705a79eb4b3b8f7ec059b14436bbf4c7c43d8cd484ea4ca2f3e5a5481fe193aa9f0785cb9294db6d88a0cab065f8f1c34cd4ada52fb2b9a968aacea6847e2850cfc960cb3940fe67dad5c5131443ca5074a83dbb6cacaad81cdef91be2618317626d1e7a3f56fb926e28667e96ef160f8d64178fa32f5a7bc81a48be67bb166ec2e494b645f76c14a14fbfee9bb44a2bc5f8df02008d737ff1340237ef5181c7efa7a186a72731f4079f8788814bc269b80e0915dff99b8f4cce4ad2b961703334d71fcf5dfabf9f70c5a04f79feea8256ce1ca0e04bcf6cb995e2783c750ebb0dba7c4bbe9a4aa2178c1262dc2f71784e0b82bd32251ea53d12d6debb46622b5615b6c1e64f29581bb53059688949c67d33cc7f9f4e58a78b366458630c7decdec1cb5c84e29779c7edeb93180a062ef4509bc963dfd6b881ab7b6b069fc146a4d43de8c10bef190e6937493c5f3d765c1349bf96d426db11453bd31526015079d3e9273582d8dbe476931acd7466c29ef825929a3d5e8963033a53f4d8a95441e6f13741146a66145f97c107997a68da4b02ece7f7d6ecbe243b1c7704242ec637acb0c4c41925b71f495e16629a2640f4b9e37e1caac30995fbcb3be84e338d6005cf8aa579ca43c28abebd57094b5f7f41082a930787dc0220c194197e96e1c86664d63e9b7970d3b43e3e02820cafa1f3f22f3fa50d74aceef5237111b82ef7704c7a1ff7cfb57729ec3037835adbb8c1d0c1b7d667776ff671013fd3c3384",
    44475:
      "0c0cafb17e7862ac85283f96a50ebf5c5f9d720927608932690419d2f59a3c719cb0301598a357d8b6468157a956f12fe92347071ef9808633871cefb2d4d0f059c627bcfc25e3f4d93048dfd76e6b1cafee1ae999380dc61fa3a09cdc2ba667e6b502759290e20a4c6d597533a6ff1a13f3cdcc26b550cdbbaf6578dddf30e5a41668614b034904328207d849dd947ad99ad88cff324dd6caa4cf41993611ced43e58f2b484dee033e2f50a9f2c5a1a65b47275d029b2132088712c9ef6b3847982593d93f66e056d581cc093f061db8421c56a12aea04929eea0ac22ee27276a53ed32543440ee07d05fcfda3fb0b1a8772bc6bf63569923e19b5dfcd25621ce9b9bf80c9e705dbd070c97cd0fa86c4500c8795baab00b70ec0e9d123f72afbe33cdd0a55ac281b134c075cf8a758f949d258428d3c16da7a8db80b875736f9e046d028b5bc0569c47c93355b5487daf276dc59af3185712cd52cca67d6411ad01db166fb28904dc8d4b86da0ee8af029aaf57d6653363ff7c1310b52ab1f48f23256c6a48031bd53be7ed8c32d80723b969c0a573b6ff458f59f72f432556f016aa8b4eea13d59273b6825a8c2ec91956ee738390a48b2789501efe5d6d3bddae5a9b0582fc8bdd7c8e217e9fa73f2528af234585adc47ea83db8012ebfebbca35947fe7b1051acbc77bfd0aabccf59d9222857c6056f5efb31da3209dc885e895a541d16e85498b82f622cb13d1167a501f5e3cb2325fbd9337158baf8b39b46d59c3df076a843c2531f2b4e814028f5fe9ba0276546de3124bc25cf393a035432978eec56beb69a18ed18db97c1ca63f9d955bc882566fed7f78d42a9d2cdcd689eefc3f464efa806cb83c1d07b1c71200684b429de360744a5fd1556ee8982e5fc9bf7981a73e66163fd1758ab832ffd8dd4e29db681f8bb46bba81f96168b89fc74b366cd00a78c1548487e52037250704c66e3cd22649aaf4ddf6d05edaa8c2d4943341cba9634c3e37d487f821198697e006f6c392dd91439ab625ae77d3fbef15bf537b93343a5f92cf0c946c7abebd5cdf3aee517745ea9d30ddf40ba9a17339f7441bd46fc86ba433500bde446be55d51da92f69ae35e3c95f0ecd58a7f2754df65acce71306a520f6f5a9b2e448af31aea604a6f4eb9c6061a54286cb0546549e7468f40f3bc9c4afde9d87e68024bc12aad962f9eff056493fb01e8cd207adffa8aa157211b251f7a18e1c6dc33ac7d18820f165bab6339829ad6eaa0899551ef9d21d481ab327a871243a48ede2abcfcb336321171a91acc23b564ae589c8fcb1eed97f3a824cf2d0182c0cd20d2be634a086f3ba441548c714c175c1934e983ab43f404bb310ea87e11d8e656ee63ac2dd758a6277138f8745e4bd040a6977ebc41fd643ee154213ab51066d37b018307ac15dd2e52e98e155ca125af851db96b4ec4b0a09e06b21291ef01a9f08519c221633af6b88c670e35595ad3f9dec403eb6842773f202911452a21ae514eca3f0522193300463e45eff69f31f0f62a6e1ef5608fb89c0d92d50c077f78916e69784f64e43b165936b4f76343c82fa2453db9682b9733314f40d813d6020ec4fd204b1523d1a4db8a665ec0c61ed89831b53e64811f3d2df90fb556817e49556bff4d38c5fbd84dbb7eae9cdc55d02aecbb0c39d751c72703421780bd0fbd23df4ab4adf34e9a8f6f9843ab6d0d61b3f78ab57f29a93ca9274f4fcf641638645e1de4860d067bd2070a882368703e232e482d7f7f9cbc9604b236c014c0c4d2500908c9d16ddb314a98f8c68ee2387817a9c7b6fabc351de31b7147464d05b6b47261d6c04a33ed5417aa1aef40b6a6efb19a54aba27966308e530a25ba765",
  },
};

export async function up(knex: Knex): Promise<void> {
  const environment = process.env.MIGRATION_ENV;
  if (!isDefined(environment) || !validEnvironments.includes(environment)) {
    throw new Error(
      `run this migration as: MIGRATION_ENV=<env> yarn migrate. <env>: ${validEnvironments.join(
        " | "
      )}`
    );
  }
  if (environment === "local") {
    console.warn("local environment, skipping migration...");
    return;
  }

  const encryptedKeys = Object.entries(encryptedCredentialsMap[environment]);

  const { rows } = await knex.raw<{ rows: { id: number }[] }>(/* sql */ `
    select id from org_integration oi where "provider" = 'DOW_JONES_KYC';
  `);

  // make sure every id in database is defined on the encryptedKeys map
  rows.forEach((integration) => {
    const encrypted = encryptedKeys.find(([id]) => integration.id === parseInt(id));
    if (!encrypted) {
      throw new Error(
        `OrgIntegration:${integration.id} is not defined on encryptedCredentialsMap. Update the migration and try again.`
      );
    }
  });

  await knex.raw(
    /* sql */ `
        with encrypted_keys("id", "encrypted") 
        as (values ${encryptedKeys.map(() => "(?::int, ?::text)").join(", ")})
        update "org_integration" oi
        set settings = settings || jsonb_build_object(
            '_CREDENTIALS', "settings"->'CREDENTIALS', -- just in case, will be removed in future migration
            'CREDENTIALS', ek.encrypted
        )
        from "encrypted_keys" ek
        where oi."provider" = 'DOW_JONES_KYC' and oi.id = ek.id;
    `,
    encryptedKeys.flatMap(([id, encrypted]) => [parseInt(id), encrypted])
  );
}

export async function down(knex: Knex): Promise<void> {
  await knex.raw(/* sql */ `
    update org_integration
    set settings = (settings || jsonb_build_object('CREDENTIALS', settings->'_CREDENTIALS')) - '_CREDENTIALS'
    where "provider" = 'DOW_JONES_KYC' and settings->'_CREDENTIALS' is not null
  `);
}
