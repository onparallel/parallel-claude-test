name: Cancel merged branch runs

on:
  pull_request:
    types: [closed]

jobs:
  cancel-runs:
    name: Cancel branch runs
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Cancel all runs for merged branch
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;
            const { owner, repo } = context.repo;

            const ignoredWorkflows = [
              'asana-task-mover.yml',
              'cancel-merged-branch.yml',
            ].map(name => `.github/workflows/${name}`);

            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch,
              status: 'in_progress',
              per_page: 100,
            });

            const queuedRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              branch,
              status: 'queued',
              per_page: 100,
            });

            const allRuns = [...runs.data.workflow_runs, ...queuedRuns.data.workflow_runs];

            let cancelled = 0;
            for (const run of allRuns) {
              if (ignoredWorkflows.includes(run.path)) continue;
              try {
                console.log(`Cancelling run ${run.id} (${run.name}) - status: ${run.status}`);
                await github.rest.actions.cancelWorkflowRun({
                  owner,
                  repo,
                  run_id: run.id,
                });
                cancelled++;
              } catch (error) {
                console.log(`Failed to cancel run ${run.id} (${run.name}): ${error.message}`);
              }
            }
