name: Claude Code Review

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr-diff.txt
          echo "Diff saved to /tmp/pr-diff.txt"

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          additional_permissions: |
            gh pr comment
            gh pr review
            git diff
            git log
            git remote
          prompt: |
            You are reviewing Pull Request #${{ github.event.pull_request.number }} in repository ${{ github.repository }}.

            PR Title: ${{ github.event.pull_request.title }}
            PR Author: ${{ github.event.pull_request.user.login }}
            Base branch: ${{ github.base_ref }}
            Head branch: ${{ github.head_ref }}

            IMPORTANT: Read the diff file at /tmp/pr-diff.txt to see the changes.
            Also use the Read tool to examine the changed files in detail.

            Issues to look for:
            1. SQL injection (string concatenation in SQL queries) - CRITICAL
            2. console.log statements left in code
            3. Unused variables
            4. Using 'let' when 'const' would be better
            5. Security vulnerabilities

            After reviewing, use this command to post your review comment:
            gh pr comment ${{ github.event.pull_request.number }} --body "YOUR_REVIEW_HERE"

            Or use gh pr review to leave a formal review:
            gh pr review ${{ github.event.pull_request.number }} --comment --body "YOUR_REVIEW_HERE"

            If you find CRITICAL issues, clearly mark them in your comment.

concurrency:
  group: ${{ github.ref }}-claude-review
  cancel-in-progress: true
