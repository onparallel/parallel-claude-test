name: Claude Code Review

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          additional_permissions: |
            gh pr *
            gh api *
          prompt: |
            You are a code reviewer. Review this pull request and leave comments directly on the PR.

            IMPORTANT: You MUST leave review comments on the PR for any issues you find.

            Look for these issues and comment on them:
            1. SQL injection vulnerabilities (string concatenation in queries)
            2. console.log statements (should not be in production code)
            3. Unused variables
            4. 'let' that should be 'const' (when variable is never reassigned)
            5. Security issues

            For each issue found, create a review comment on the specific line.
            Use GitHub's suggestion feature when you can provide a fix.

concurrency:
  group: ${{ github.ref }}-claude-review
  cancel-in-progress: true
