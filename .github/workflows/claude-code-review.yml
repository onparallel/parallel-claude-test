name: Claude Code Review

on:
  pull_request:
    branches: [master]
    types: [opened, synchronize, reopened]

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create MCP Config
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "github": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-github"],
                "env": {
                  "GITHUB_PERSONAL_ACCESS_TOKEN": "${GH_TOKEN}"
                }
              }
            }
          }
          EOF

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          show_full_output: true
          claude_args: |
            --mcp-config /tmp/mcp-config.json
            --allowedTools mcp__github__*
          prompt: |
            You are a code reviewer. Review this pull request and leave comments directly on the PR.

            Use the GitHub MCP tools to create review comments:
            - Use mcp__github__create_pull_request_review to submit a review with comments
            - Use mcp__github__get_pull_request_diff to see the changes

            Look for these issues and comment on them:
            1. SQL injection vulnerabilities (string concatenation in queries)
            2. console.log statements (should not be in production code)
            3. Unused variables
            4. 'let' that should be 'const' (when variable is never reassigned)
            5. Security issues

            For each issue found, create a review comment on the specific line.

concurrency:
  group: ${{ github.ref }}-claude-review
  cancel-in-progress: true
