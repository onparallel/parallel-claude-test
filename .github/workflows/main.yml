name: CI

on:
  push:
    branches: [develop]
    paths-ignore:
      - "docs/**"
      - "ops/**"

  pull_request:
    branches: [develop]
    paths-ignore:
      - "docs/**"
      - "ops/**"

concurrency:
  group: ${{ github.ref }}-main
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
      bin: ${{ steps.filter.outputs.bin }}
      e2e: ${{ steps.filter.outputs.e2e }}
      root-config: ${{ steps.filter.outputs.root-config }}
      any-project: ${{ steps.any.outputs.any-project }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            server:
              - 'server/**'
            client:
              - 'client/**'
            bin:
              - 'bin/**'
            e2e:
              - 'e2e/**'
            root-config:
              - 'eslint.config.mjs'
              - 'tsconfig.json'
              - 'yarn.lock'
              - 'package.json'
              - '.nvmrc'
      - name: Check if any project changed
        id: any
        run: |
          if [[ "${{ steps.filter.outputs.server }}" == "true" || \
                "${{ steps.filter.outputs.client }}" == "true" || \
                "${{ steps.filter.outputs.bin }}" == "true" || \
                "${{ steps.filter.outputs.e2e }}" == "true" || \
                "${{ steps.filter.outputs.root-config }}" == "true" ]]; then
            echo "any-project=true" >> "$GITHUB_OUTPUT"
          else
            echo "any-project=false" >> "$GITHUB_OUTPUT"
          fi

  lint:
    name: Lint
    needs: detect-changes
    if: needs.detect-changes.outputs.any-project == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-yarn-cache-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-cache-
      - name: Install dependencies
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile --production=false

      - name: Lint server
        if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: npx eslint --quiet server/

      - name: Lint client
        if: needs.detect-changes.outputs.client == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: npx eslint --quiet client/

      - name: Lint bin
        if: needs.detect-changes.outputs.bin == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: npx eslint --quiet bin/

      - name: Lint e2e
        if: needs.detect-changes.outputs.e2e == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: npx eslint --quiet e2e/

      - name: Check server translations
        if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: |
          yarn workspace @parallel/server extract-i18n-terms
          yarn workspace @parallel/server generate-i18n-files

      - name: Check client translations
        if: needs.detect-changes.outputs.client == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: |
          yarn workspace @parallel/client extract-i18n-terms:recipient
          yarn workspace @parallel/client generate-i18n-files:recipient
          yarn workspace @parallel/client extract-i18n-terms:app
          yarn workspace @parallel/client generate-i18n-files:app

  check-types:
    name: Check types
    needs: detect-changes
    if: needs.detect-changes.outputs.any-project == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
      - uses: actions/cache@v4
        id: yarn-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-yarn-cache-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-cache-
      - name: Install dependencies
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        run: yarn install --frozen-lockfile --production=false

      - name: Check server types
        if: needs.detect-changes.outputs.server == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: yarn workspace @parallel/server check-types

      - name: Check client types
        if: needs.detect-changes.outputs.client == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: yarn workspace @parallel/client check-types

      - name: Check bin types
        if: needs.detect-changes.outputs.bin == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: yarn workspace @parallel/bin check-types

      - name: Check e2e types
        if: needs.detect-changes.outputs.e2e == 'true' || needs.detect-changes.outputs.root-config == 'true'
        run: yarn workspace @parallel/e2e check-types

  code-review:
    name: Code Review
    needs: [lint, check-types]
    if: |
      always() &&
      github.event_name == 'pull_request' &&
      needs.lint.result != 'failure' && needs.lint.result != 'cancelled' &&
      needs.check-types.result != 'failure' && needs.check-types.result != 'cancelled'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_args: |
            --allowedTools "Bash" "Skill"
          prompt: |
            You are running in GitHub Actions CI. PR number is ${{ github.event.pull_request.number }}.

            Run the /code-review skill to analyze this PR for security vulnerabilities and code quality issues.
            Use `git diff origin/${{ github.base_ref }}...HEAD` to get the changes.
