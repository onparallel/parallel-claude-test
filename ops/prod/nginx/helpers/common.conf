# include /etc/nginx/helpers/maintenance.conf;

add_header Strict-Transport-Security
    "max-age=2592000; includeSubDomains"
    always;

# used for healthchecks and also checking if there's a new version available
location = /status {
    default_type text/plain;
    return 200 "#COMMIT_SHA#";
}

# expose backend server
location ~ ^/(ping|api|graphql)(/.*)?$ {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_pass http://localhost:4000;
}

# on recipient pages if browser is insdecure show the "update browser" page
location ~ ^(/en|/es)?/(petition|pp|thanks)(/|$) {
    if ($outdated) {
        rewrite ^(/en|/es)?.* $1/update break;
    }
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# proxy to nextjs pages
location ~ ^(/en|/es)?(/app(/.*)?|/login|/forgot)(/|$) {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# I don't think this is necessary anymore, since all scripts are loaded from static.onparallel.com
location ~ ^/_next/ {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# favicon
location = /favicon.ico {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# for cert renewals, not sure if necessary
location ~ /\.well-known/acme-challenge/ {
    root /nfs/parallel/www/html;
}
