# best practices for ssl configuration
include /etc/nginx/helpers/ssl.conf;

# modsecurity on;
# modsecurity_rules_file /etc/nginx/modsec/main.conf;


# anything is fine, as instance can only receive traffic from the lb
set_real_ip_from 0.0.0.0/0;
# set client ip the one from the proxy_protocol;
real_ip_header proxy_protocol;

# include /etc/nginx/helpers/maintenance.conf;

# used for healthchecks and also checking if there's a new version available
location = /status {
    default_type text/plain;
    return 200 "#COMMIT_SHA#";
}

# expose backend server
location ~ ^/(ping|api|graphql)(/.*)?$ {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_pass http://localhost:4000;
}

# on recipient pages if browser is insdecure show the "update browser" page
location ~ ^(/en|/es)?/(petition|pp|thanks)(/|$) {
    if ($outdated) {
        rewrite ^(/en|/es)?.* $1/update break;
    }
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# proxy to nextjs pages
location ~ ^(/en|/es)?(/app(/.*)?|/login|/forgot)(/|$) {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# I don't think this is necessary anymore, since all scripts are loaded from static.onparallel.com
location ~ ^/_next/ {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# favicon
location = /favicon.ico {
    include /etc/nginx/helpers/nextjs-proxy-pass.conf;
}

# for cert renewals, not sure if necessary
location ~ /\.well-known/acme-challenge/ {
    root /nfs/parallel/www/html;
}